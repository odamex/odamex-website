AWSTemplateFormatVersion: 2010-09-09
Description: Odamex backend application pipeline
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Project Information
        Parameters:
          - EnvironmentName
          - ProjectName
          - ProjectURL
          - HostedZoneId
          - EmailDomainSourceArn
      - Label:
          default: Source Repository Information
        Parameters:
          - GitHubOwner
          - GitHubTokenParameterName
          - GoogleMapsApiKeyParameterName
          - AppRepo
          - AppBranch
      - Label:
          default: Network Information
        Parameters:
          - VPCID
          - VPCPrivateSubnets
          - VPCDefaultSecurityGroup
          - WAFArn
Parameters:
  AppBranch:
    Description: GitHub repository branch name
    Type: String
    Default: 'dev'
    AllowedValues:
      - 'local'
      - 'dev'
      - 'qa'
      - 'main'
  AppRepo:
    Description: GitHub repository name
    Type: String
    Default: 'odamex'
  EmailDomainSourceArn:
    Description: ARN for the SES verified identity
    Type: String
  EnvironmentName:
    Description: Environment name
    Type: String
    Default: 'dev'
    AllowedValues:
      - 'local'
      - 'dev'
      - 'qa'
      - 'stg'
      - 'prod'
  GitHubOwner:
    Description: GitHub username owning the repo
    Type: String
    Default: odamex
  ProjectName:
    Description: Primary project name
    Type: String
    Default: 'odamex'
  ProjectURL:
    Description: URL for the web application
    Type: String
    Default: ''
  HostedZoneId:
    Description: Route 53 hosted zone ID for the API custom domain
    Type: String
  VPCID:
    Description: Existing VPC ID (provisioned by ITS)
    Type: AWS::EC2::VPC::Id
  VPCPrivateSubnets:
    Description: Private subnets associated with the existing VPC
    Type: List<AWS::EC2::Subnet::Id>
  VPCDefaultSecurityGroup:
    Description: Default security group associated with the existing VPC
    Type: AWS::EC2::SecurityGroup::Id
  WAFArn:
    Description: WAF V2 Web ACL Arn for API Gateway and CloudFormation (from ITS)
    Type: String

Conditions:
  IsDev: !Equals
    - !Ref EnvironmentName
    - dev
  IsProd: !Equals
    - !Ref EnvironmentName
    - prod
  IsNotProd: !Not
    - !Condition IsProd

Resources:
  # Role used to give CodePipeline to release a build.
  CodePipelineServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-${EnvironmentName}-CodePipelineServiceRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: codepipeline.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub ${ProjectName}-${EnvironmentName}-CodePipelineServicePolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              # Allow codepipeline to put artifacts in the S3 bucket
              # as well as get artifacts back out of it.
              - Resource: '*' #  - !Sub arn:aws:s3:::${ArtifactBucket}/*
                Effect: Allow
                Action:
                  - s3:*
                  - ecr:*
                  - codebuild:StartBuild
                  - codebuild:BatchGetBuilds
                  - iam:PassRole
                  - cloudformation:CreateChangeSet
                  - cloudformation:CreateStack
                  - cloudformation:CreateUploadBucket
                  - cloudformation:DeleteStack
                  - cloudformation:Describe*
                  - cloudformation:List*
                  - cloudformation:UpdateStack
                  - cloudformation:ValidateTemplate
                  - cloudformation:ExecuteChangeSet
                  - ssm:GetParameter
                  - ssm:DescribeParameters
                  - ssm:GetParameters

  # CloudFormation deployment role. This role is passed by CodeBuild to
  # CloudFormation to use when setting up the application resources
  CloudFormationDeployRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${ProjectName}-${EnvironmentName}-CloudFormationDeployRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: cloudformation.amazonaws.com
            Action: sts:AssumeRole
          - Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub ${ProjectName}-${EnvironmentName}-CloudFormationDeployPolicy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - 'acm:*'
                  - 'apigateway:*'
                  - 'cloudformation:*'
                  - 'cloudfront:*'
                  - 'cloudtrail:*'
                  - 'cloudwatch:*'
                  - 'codebuild:*'
                  - 'codepipeline:*'
                  - 'cognito-identity:*'
                  - 'cognito-idp:*'
                  - 'dynamodb:*'
                  - 'ec2:*'
                  - 'ecr:*'
                  - 'ecs:*'
                  - 'events:*'
                  - 'iam:*'
                  - 'lambda:*'
                  - 'logs:*'
                  - 'rds:*'
                  - 'route53:*'
                  - 's3:*'
                  - 'secretsmanager:*'
                  - 'ses:*'
                  - 'sns:*'
                  - 'ssm:*'
                  - 'states:*'
                  - 'wafv2:*'
                Resource: '*'

  # While the build is in progress we need a place to store artifacts
  ArtifactBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # Infrastructure bucket to hold nested stacks and lambda code
  InfrastructureBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: RetainExceptOnCreate
    Properties:
      BucketName: !Sub '${ProjectName}-${EnvironmentName}-infrastructure'
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration:
        Rules:
          - NoncurrentVersionTransition:
              NewerNoncurrentVersions: 5
              StorageClass: INTELLIGENT_TIERING
              TransitionInDays: 2557 # Number of days in 7 years
            Status: Enabled
      NotificationConfiguration:
        EventBridgeConfiguration:
          EventBridgeEnabled: true
      VersioningConfiguration:
        Status: Enabled
  InfrastructureBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref InfrastructureBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: 'AllowSSLRequestsOnly'
            Effect: 'Deny'
            Principal: '*'
            Action: 's3:*'
            Resource:
              - !GetAtt InfrastructureBucket.Arn
              - !Join ['', [!GetAtt InfrastructureBucket.Arn, '/*']]
            Condition:
              Bool:
                aws:SecureTransport: 'false'

  # This pipeline defines the steps to build, deploy, and release the application
  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Sub ${ProjectName}-${EnvironmentName}-pipeline
      Tags:
        - Key: EnvironmentName
          Value: !Ref EnvironmentName
      RoleArn: !GetAtt CodePipelineServiceRole.Arn
      ArtifactStore:
        Type: S3
        Location: !Ref ArtifactBucket
      Stages:
        # First we have to pull the source code from the Github repository.
        - Name: Source
          Actions:
            - Name: App
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Provider: GitHub
                Version: '1'
              Configuration:
                Owner: !Ref GitHubOwner
                OAuthToken: !Sub '{{resolve:ssm:${GitHubTokenParameterName}}}'
                Repo: !Ref AppRepo
                Branch: !Ref AppBranch
                PollForSourceChanges: false
              OutputArtifacts:
                - Name: AppArtifact

        - Name: Testing
          Actions:
              - Name: WebAppUnitTestsBuild
                Namespace: AppUnitTestingVars
                ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Version: '1'
                  Provider: CloudFormation
                Configuration:
                  ActionMode: CREATE_UPDATE
                  RoleArn: !GetAtt CloudFormationDeployRole.Arn
                  StackName: !Sub '${ProjectName}-${EnvironmentName}-app-build-tests-project'
                  TemplatePath: AppArtifact::infrastructure/stacks/app-tests-build.yml
                  Capabilities: CAPABILITY_NAMED_IAM
                  ParameterOverrides: !Sub |
                    { 
                      "EnvironmentName": "${EnvironmentName}",
                      "ProjectName": "${ProjectName}",
                    }
                InputArtifacts:
                  - Name: AppArtifact
                RunOrder: 1

            # app unit test
              - Name: WebAppUnitTests
                ActionTypeId:
                  Category: Build
                  Owner: AWS
                  Version: '1'
                  Provider: CodeBuild
                Configuration:
                  ProjectName: '#{AppUnitTestingVars.CodeBuildProject}'
                  PrimarySource: AppArtifact
                InputArtifacts:
                  - Name: AppArtifact
                RunOrder: 2

        - Name: Resources
          Actions:
            # DB
            - Name: DB
              Namespace: DBVars
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: '1'
                Provider: CloudFormation
              Configuration:
                ActionMode: CREATE_UPDATE
                RoleArn: !GetAtt CloudFormationDeployRole.Arn
                StackName: !Sub '${ProjectName}-${EnvironmentName}-database'
                TemplatePath: AppArtifact::infrastructure/stacks/db.yml
                Capabilities: CAPABILITY_NAMED_IAM
                ParameterOverrides: !Sub |
                    {
                      "EnvironmentName": "${EnvironmentName}",
                      "ProjectName": "${ProjectName}",
                      "DatabaseSubnetList": "${VPCPrivateSubnets}",
                      "VPCID": "${VPCID}",
                      "VPCDefaultSecurityGroup": "${VPCDefaultSecurityGroup}"
                    }
              InputArtifacts:
                - Name: AppArtifact
              RunOrder: 1

            # authentication
            - Name: AuthProvider
              Namespace: AuthVars
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: '1'
                Provider: CloudFormation
              Configuration:
                ActionMode: CREATE_UPDATE
                RoleArn: !GetAtt CloudFormationDeployRole.Arn
                StackName: !Sub '${ProjectName}-${EnvironmentName}-auth'
                TemplatePath: AppArtifact::infrastructure/stacks/auth.yml
                Capabilities: CAPABILITY_NAMED_IAM
                ParameterOverrides: !Sub |
                  {
                    "DBAdminSecret": "#{DBVars.DBAdminPasswordV2}",
                    "DBClusterArn": "#{DBVars.DatabaseClusterArnV2}",
                    "EmailDomainSourceArn": "${EmailDomainSourceArn}",
                    "EnvironmentName": "${EnvironmentName}",
                    "ProjectName": "${ProjectName}",
                    "ProjectURL": "${ProjectURL}"
                  }
              InputArtifacts:
                - Name: AppArtifact
              RunOrder: 2

            #ApiSocketVars - API Socket
            - Name: APIRest
              Namespace: ApiRestVars
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: '1'
                Provider: CloudFormation
              Configuration:
                ActionMode: CREATE_UPDATE
                RoleArn: !GetAtt CloudFormationDeployRole.Arn
                StackName: !Sub '${ProjectName}-${EnvironmentName}-api-rest'
                TemplatePath: AppArtifact::infrastructure/stacks/api-rest.yml
                Capabilities: CAPABILITY_AUTO_EXPAND,CAPABILITY_NAMED_IAM
                ParameterOverrides: !Sub |
                    { 
                      "DatabaseSecurityGroup": "${VPCDefaultSecurityGroup}",
                      "DatabaseSubnetList": "${VPCPrivateSubnets}",
                      "DBAdminSecret": "#{DBVars.DBAdminPasswordV2}",
                      "EnvironmentName": "${EnvironmentName}",
                      "ProjectName": "${ProjectName}",
                      "HostedZoneId": "${HostedZoneId}",
                      "ProjectURL": "${ProjectURL}",
                      "UserPoolId": "#{AuthVars.UserPoolId}",
                      "UserPoolArn": "#{AuthVars.UserPoolArn}",  
                      "WAFArn": "${WAFArn}"
                    }
              InputArtifacts:
                - Name: AppArtifact
              RunOrder: 4

            #AppBuildVars - App build project
            - Name: AppBuildProject
              Namespace: AppBuildVars
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: '1'
                Provider: CloudFormation
              Configuration:
                ActionMode: CREATE_UPDATE
                RoleArn: !GetAtt CloudFormationDeployRole.Arn
                StackName: !Sub '${ProjectName}-${EnvironmentName}-app-build-project'
                TemplatePath: AppArtifact::infrastructure/stacks/app-build.yml
                Capabilities: CAPABILITY_NAMED_IAM
                ParameterOverrides: !Sub |
                    { 
                      "EnvironmentName": "${EnvironmentName}",
                      "ProjectName": "${ProjectName}",
                      "VPC": "${VPCID}",
                      "PrivateSubnets": "${VPCPrivateSubnets}",
                      "SecurityGroup": "${VPCDefaultSecurityGroup}",
                      "DBAdminSecret": "#{DBVars.DBAdminPasswordV2}",
                      "DBClusterArn": "#{DBVars.DatabaseClusterArnV2}"
                    }
              InputArtifacts:
                - Name: AppArtifact
              RunOrder: 5

            # builds app files
            # update S3
            # clears cloudfront dist
            - Name: Deploy
              Namespace: DeployVars
              ActionTypeId:
                Category: Build
                Owner: AWS
                Version: '1'
                Provider: CodeBuild
              Configuration:
                ProjectName: '#{AppBuildVars.CodeBuildProject}'
                PrimarySource: AppArtifact
              InputArtifacts:
                - Name: AppArtifact
              OutputArtifacts:
                - Name: BuildOutput
              RunOrder: 6
