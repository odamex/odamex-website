AWSTemplateFormatVersion: 2010-09-09
Description: The resources used to create the WebApp EnvironmentName.
Parameters:
  EnvironmentName:
    Type: String
    Description: The name for the EnvironmentName that this cloudformation will be part of.
  ProjectName:
    Description: Primary project name
    Type: String
    Default: 'odamex'
  GitHubTokenParameterName:
    Type: String
    NoEcho: true

Conditions:
  TestStage: !Equals [!Ref EnvironmentName, test]
  NotTestStage: !Not [Condition: TestStage]

Resources:
  CodeTestBuildServiceRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: !Sub ${ProjectName}-${EnvironmentName}-CodeTestBuildServiceRole
      Tags:
        - Key: platform
          Value: odamex
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: !Sub ${ProjectName}-${EnvironmentName}-CodeTestBuildServiceRole
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Action:
                  - 'cloudfront:*'
                  - 'ec2:*'
                  - 'lambda:*'
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                  - 'rds:*'
                  - 'rds-data:*'
                  - 's3:*'
                  - 'ssm:*'
                Effect: Allow
                Resource: '*'
              - Action:
                  - 'kms:Decrypt'
                  - 'kms:DescribeKey'
                  - 'kms:Encrypt'
                  - 'kms:GenerateDataKey*'
                  - 'kms:ReEncrypt*'
                Effect: Allow
                Resource:
                  - arn:aws:kms:us-east-1:370695041566:key/8bf6e3d2-955d-4764-9f8f-52e522753ca6
                  - arn:aws:kms:us-east-1:370695041566:key/a8a96f13-a527-4556-accc-e602e1cd1414
  CodeTestBuildProject:
    Type: 'AWS::CodeBuild::Project'
    Properties:
      Tags:
        - Key: platform
          Value: odamex
      Artifacts:
        Type: CODEPIPELINE
      Source:
        Type: CODEPIPELINE
        BuildSpec: |
          version: 0.2
          phases:
            install:
              runtime-versions:
                nodejs: latest
            build:
              commands:
                - npm install -g typescript
                - cd $CODEBUILD_SRC_DIR/api/src
                # REST API LAMBDA TESTS
                - npm install 
                - tsc 
                - npm prune --omit=dev
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        Image: 'aws/codebuild/amazonlinux2-x86_64-standard:5.0'
        Type: LINUX_CONTAINER
        EnvironmentVariables:
          - Name: EnvironmentName
            Value: !Ref EnvironmentName
      Name: !Sub ${ProjectName}-${EnvironmentName}-CodeTestBuildProject
      ServiceRole: !Ref CodeTestBuildServiceRole
    #   VpcConfig:
    #     VpcId: !Ref VPC
    #     Subnets: !Ref PrivateSubnets
    #     SecurityGroupIds:
    #       - !Ref SecurityGroup

Outputs:
  CodeBuildProject:
    Value: !Ref CodeTestBuildProject
